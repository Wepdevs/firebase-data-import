<!--<link rel="import" href="../polymer/polymer.html">-->
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">


<!--
`firebase-data-import`
import data from a .json file to firebase

@demo demo/index.html 
-->

<dom-module id="firebase-data-import">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <firebase-app 
      id="firebase"
      name="app"    
      api-key="[[apiKey]]"
      auth-domain="[[authDomain]]"
      database-url="[[databaseUrl]]"
      app="{{app}}">
    </firebase-app>
    <firebase-auth id="auth" app-name="app" user="{{user}}" provider="google" on-error="handleError">
    </firebase-auth>
    <firebase-query
      app-name="app"
      id="query"
      path="prova"
      data="{{data}}">
    </firebase-query>

    <iron-pages selected="{{selected}}" id="iron-pages-import">
      <div>
          <h2>1. Select Firebase DataBase</h2>
          <paper-input  id="DBConn" value="{{databaseUrl}}"
          error-message="needs some text" required auto-validate>{{databaseUrl}}</paper-input>  
      </div>
      <div>
          <h2>2. Databse Authentication</h2>
          <paper-input label="Email"  id="email" value="{{email}}"
          error-message="needs some text" required auto-validate></paper-input>
          <paper-input type="password" label="Password"  id="password" value="{{password}}"
          error-message="needs some text" required auto-validate></paper-input>
          <!--<paper-input label="login error" id="loginError"></paper-input>-->
          <paper-input-container id="loginError">
          <!--<label>Login error</label>-->
          <input is="iron-input">
          </paper-input-container>
      </div>
      <div>
          <h2>3. Select JSON file to upload into database</h2>
          <paper-input type="file" label="file" id="file"></paper-input>
    </div>
    <div>
       <h2>4. Select in which branch of Firebase to upload</h2>
           <paper-dropdown-menu label="Branches">
              <paper-menu class="dropdown-content" id="branchesMenu" selected="{{chosenBranch}}" attr-for-selected="name">
                    <template is="dom-repeat" items="{{branches}}" as="branch">
                        <paper-item name="[[branch.name]]">[[branch.name]]</paper-item>
                    </template>
                </paper-menu>
        </paper-dropdown-menu>
       </div>
       <div>
          <h2>5. Result</h2>
          <div>Import completed!</div>
      </div>  
    </iron-pages>
    <paper-button on-tap="prevPage" disabled$="{{_computeHiddenPrev(selected)}}">PREV</paper-button>
    <paper-button on-tap="nextPage" disabled$="{{_computeHiddenNext(selected)}}">NEXT</paper-button>


    <h3>Config</h3>
    <div>auth Domain: [[authDomain]]</div>
    <div>database Url: [[databaseUrl]]</div>
    <div>api Key: [[apiKey]]</div>
    <div>user email: [[user.email]]</div>


    <!--<template is="dom-repeat" items="{{data}}">
      <div>elemento:  [[item.nome]]</div>
    </template>
    -->
    <div on-tap="tap">tap</div>
    

  </template>

  <script>
    Polymer({

      is: 'firebase-data-import',

      properties: {
            authDomanin:String,
            databaseUrl:String,  
            apiKey:String,
            user:Object,
            selected: {type: Number,value: 0},
            app:Object,
            data:Object,
            email:{type:String, value: "walter.miani@gmail.com"},
            password:{type:String, value: "walter.miani@gmail.com"},
            file:Object,
        },

        tap:function(){
          // this.$.firebase.app.database().ref().child('try').push({nome:"asd"});
          console.log(this.file);
        },

      nextPage: function(){
            var pages = document.querySelector('#iron-pages-import');
            var errorText = document.querySelector('#loginError input');

            switch(this.selected){
                case 0: 
                    if(this.$.DBConn.validate())
                        pages.selectNext();
                    break;
                case 1:
                    if(this.$.email.validate() && this.$.password.validate()){
                        this.$.auth.signInWithEmailAndPassword(this.$.email.value, this.$.password.value);
                        
                        this.$.file.addEventListener('change', this.saveFile);
                        
                        var ref = this.$.firebase.app.database().ref();
                        this.getBranches(ref);
                        pages.selectNext();
                    } 
                    break;
                case 2:
                    if(this.validateFile()){
                        pages.selectNext();
                    }   
                    else{
                        alert('Upload a file!');
                    }
                    break;
                case 3:
                    this.importData();
                    pages.selectNext();
                    break;
                default:
                    pages.selectNext();
            }
        },
        
        prevPage: function(){
            var pages = document.querySelector('#iron-pages-import');
            switch(this.selected){
                case 0: 
                    break;
                default:
                    pages.selectPrevious();
            }   
        },

        _computeHiddenNext: function(){
            return this.selected == 4;
        },
        _computeHiddenPrev: function(){
            return this.selected == 0;
        },

        getBranches: function(ref){
          
            var branches = [];
            
            ref.once('value').then(function(snapshot){

              snapshot.forEach(function(childsnapshot){
                  branches.push({name: childsnapshot.key});
              });

            });

         },

          validateFile: function(){

            console.log(this.$.file);

            return (this.$.file.file);  
        },

        saveFile: function(e){
            
            console.log('salvo il file');
            this.file = e.target.files[0];
            event.stopPropagation();
            event.preventDefault();
        }
        
    });
  </script>
</dom-module>




<!--<script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>
<script>
  // Initialize Firebase
  // TODO: Replace with your project's customized code snippet
  var config = {
    apiKey: "<API_KEY>",
    authDomain: "<PROJECT_ID>.firebaseapp.com",
    databaseURL: "https://<DATABASE_NAME>.firebaseio.com",
    storageBucket: "<BUCKET>.appspot.com",
  };
  firebase.initializeApp(config);
</script>-->
